<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>ü©∫ MedAssist - Global Health AI</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.5.1/dist/confetti.browser.min.js"></script>

    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">

    <style>
        body {
            font-family: 'Poppins', sans-serif;
            background: linear-gradient(135deg, #6a11cb 0%, #2575fc 100%);
            color: #333;
            margin: 0; padding: 0;
            display: flex;
            height: 100vh;
        }
        .container {
            background: #fff;
            padding: 30px;
            border-radius: 20px;
            box-shadow: 0 8px 30px rgba(0,0,0,0.1);
            width: 50%;
            min-width: 400px;
            max-width: 700px;
            margin: auto;
            margin-left: 350px; /* Shift right to avoid overlap */
        }
        #sidebar {
            width: 300px;
            background: #f7f7f7;
            padding: 20px;
            display: flex;
            flex-direction: column;
            position: absolute;
            height: 100%;
            box-shadow: 2px 0 5px rgba(0,0,0,0.05);
        }
        .history-item {
            display: flex; justify-content: space-between; align-items: center;
            padding: 5px 0;
        }
        .delete-btn {
            background: none; border: none; color: #e74c3c; cursor: pointer;
        }
        textarea {
            width: 100%; height: 80px; padding: 10px; margin-top: 10px; border-radius: 10px; border: 1px solid #ccc;
        }
        button {
            padding: 10px 20px; margin-top: 10px; border: none; border-radius: 10px; cursor: pointer;
            background: #2575fc; color: white; font-weight: 600;
        }
        .type-button {
            margin-right: 10px; padding: 8px 15px; border-radius: 8px; border: none; cursor: pointer;
        }
        .active {
            background: #6a11cb; color: #fff;
        }
        footer {
            position: fixed; bottom: 10px; width: 100%; text-align: center; color: #fff; font-size: 14px;
        }
    </style>
</head>
<body>

<div id="sidebar">
    <h3><i class="fa-solid fa-clock-rotate-left"></i> History</h3>
    <div id="history">Your previous queries will appear here.</div>
    <hr>
    <strong><i class="fa-solid fa-user"></i> User:</strong> <span id="userDisplay">Not logged in</span>
    <button id="logoutButton" style="background:#e74c3c;margin-top:10px;">Logout</button>
</div>

<div class="container">
    <h1><i class="fa-solid fa-heart-pulse"></i> MedAssist</h1>

    <div id="foodHistorySection">
        <h3>Welcome! Please enter your recent food history to begin.</h3>
        <textarea id="foodHistoryInput" placeholder="e.g., I had salad for lunch, pasta for dinner..."></textarea>
        <button id="submitFoodHistory">Calculate Health Score</button>
    </div>

    <div id="appSection" style="display:none;">
        <div id="healthScore"></div>
        <textarea id="input" placeholder="e.g., Tell me about Aspirin or I have a fever"></textarea>
        <div class="type-selection">
            <button id="medicineTypeBtn" class="type-button active">üíä Medicine</button>
            <button id="symptomTypeBtn" class="type-button">ü©∫ Symptom</button>
        </div>
        <div class="button-group">
            <button id="getInsightsBtn">Get Insights</button>
            <button id="voiceInputBtn">üé§ Voice Input</button>
        </div>
        <div id="output" style="margin-top:20px;">Your insights will appear here üìù</div>
    </div>
</div>

<footer>&copy; 2025 MedAssist | Built with ‚ù§Ô∏è</footer>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
    import { getAuth, onAuthStateChanged, GoogleAuthProvider, signInWithPopup, signOut } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";

    const firebaseConfig = {
        apiKey: "AIzaSyCtx67-taPpAyzu4-TTIQXvbdQOB2Wmvrs",
        authDomain: "medassistmain.firebaseapp.com",
        projectId: "medassistmain",
        storageBucket: "medassistmain.appspot.com",
        messagingSenderId: "269618123844",
        appId: "1:269618123844:web:6a25b8b4d914739297d811"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const BACKEND_URL = "https://medassist-backend-if53.onrender.com";

    let currentType = 'medicine', userUID = '', currentIdToken = '';

    const ui = {
        sidebar: document.getElementById('sidebar'),
        userDisplay: document.getElementById('userDisplay'),
        logoutButton: document.getElementById('logoutButton'),
        history: document.getElementById('history'),
        foodHistorySection: document.getElementById('foodHistorySection'),
        foodHistoryInput: document.getElementById('foodHistoryInput'),
        submitFoodHistoryBtn: document.getElementById('submitFoodHistory'),
        appSection: document.getElementById('appSection'),
        healthScore: document.getElementById('healthScore'),
        input: document.getElementById('input'),
        output: document.getElementById('output'),
        medicineTypeBtn: document.getElementById('medicineTypeBtn'),
        symptomTypeBtn: document.getElementById('symptomTypeBtn'),
        getInsightsBtn: document.getElementById('getInsightsBtn'),
        voiceInputBtn: document.getElementById('voiceInputBtn'),
    };

    const setType = (t) => {
        currentType = t;
        ui.medicineTypeBtn.classList.toggle('active', t === 'medicine');
        ui.symptomTypeBtn.classList.toggle('active', t === 'symptom');
    };

    const updateHistory = (h) => {
        ui.history.innerHTML = "";
        if (!h || h.length === 0) {
            ui.history.innerHTML = "No history yet.";
            return;
        }
        const unique = [...new Map(h.filter(i => i.role === 'user').map(i => [i.content, i])).values()];
        unique.slice(-5).reverse().forEach(item => {
            const div = document.createElement('div');
            div.className = 'history-item';
            div.innerHTML = `<span>${item.type === "medicine" ? "üíä" : "ü©∫"} ${item.content}</span><button class="delete-btn"><i class="fa fa-trash"></i></button>`;
            div.querySelector('span').onclick = () => { ui.input.value = item.content; setType(item.type); ask(); };
            div.querySelector('.delete-btn').onclick = (e) => { e.stopPropagation(); deleteChat(item.content); };
            ui.history.appendChild(div);
        });
    };

    const handleLogin = async (user) => {
        userUID = user.uid;
        ui.userDisplay.innerText = user.email;
        currentIdToken = await user.getIdToken();
        try {
            const res = await fetch(`${BACKEND_URL}/user/profile`, {
                method: "POST",
                headers: { "Content-Type": "application/json", "Authorization": `Bearer ${currentIdToken}` },
                body: JSON.stringify({ uid: userUID })
            });
            const data = await res.json();
            if (data.health_score != null) {
                ui.foodHistorySection.style.display = 'none';
                ui.appSection.style.display = 'block';
                ui.healthScore.innerHTML = `<b>Your Health Score: ${data.health_score}/100</b><br>${marked.parse(data.message || '')}`;
                if (data.health_score >= 80) confetti({ particleCount: 150, spread: 90, origin: { y: 0.6 } });
                updateHistory(data.chat_history || []);
            } else {
                ui.foodHistorySection.style.display = 'block';
                ui.appSection.style.display = 'none';
            }
        } catch (error) {
            console.error("Error fetching profile:", error);
            alert("Error loading profile. Try again.");
        }
    };

    const submitFoodHistory = async () => {
        const history = ui.foodHistoryInput.value.trim();
        if (!history) return alert("Please enter your food history.");
        ui.submitFoodHistoryBtn.disabled = true;
        try {
            await fetch(`${BACKEND_URL}/user/food-history`, {
                method: 'POST', headers: { 'Content-Type': 'application/json', 'Authorization': `Bearer ${currentIdToken}` },
                body: JSON.stringify({ food_history: history })
            });
            await handleLogin(auth.currentUser);
        } catch (error) {
            alert("Error submitting food history.");
        } finally {
            ui.submitFoodHistoryBtn.disabled = false;
        }
    };

    const ask = async () => {
        const query = ui.input.value.trim();
        if (!query) return alert("Please enter your query.");
        ui.output.innerHTML = "‚è≥ Generating...";
        const res = await fetch(`${BACKEND_URL}/ask`, {
            method: "POST", headers: { "Content-Type": "application/json", "Authorization": `Bearer ${currentIdToken}` },
            body: JSON.stringify({ message: query, type: currentType })
        });
        const data = await res.json();
        ui.output.innerHTML = marked.parse(data.response);
        updateHistory(data.chat_history);
        ui.input.value = '';
    };

    const deleteChat = async (content) => {
        await fetch(`${BACKEND_URL}/user/chat-history/delete`, {
            method: "POST", headers: { "Content-Type": "application/json", "Authorization": `Bearer ${currentIdToken}` },
            body: JSON.stringify({ content })
        });
        await handleLogin(auth.currentUser);
    };

    ui.submitFoodHistoryBtn.onclick = submitFoodHistory;
    ui.getInsightsBtn.onclick = ask;
    ui.voiceInputBtn.onclick = () => {
        const Rec = window.SpeechRecognition || window.webkitSpeechRecognition;
        const rec = new Rec();
        rec.onresult = e => { ui.input.value = e.results[0][0].transcript; ask(); };
        rec.start();
    };
    ui.medicineTypeBtn.onclick = () => setType('medicine');
    ui.symptomTypeBtn.onclick = () => setType('symptom');
    ui.logoutButton.onclick = () => signOut(auth);

    onAuthStateChanged(auth, user => {
        if (user) handleLogin(user);
        else signInWithPopup(auth, new GoogleAuthProvider());
    });
</script>

</body>
</html>
